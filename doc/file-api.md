# File-api

## Что используется для хранения
В качестве хранилища используется S3шка yandex cloud (пока что). // для dev можно раскатить и minio, но 2 рубля в месяц не выглядят прям слишком неподъемными
- Для именования файлов применяются **UUID**, которые генерируются в **PostgreSQL**.  
- Можно загружать **любой тип файлов**, но с учетом установленных **лимитов хранилища**.  
- Вся работа с файлами ведется через **presigned URLs**, выдаваемые бэкендом.  


## Как работать с правами доступа
Каждый файл имеет свои права доступа в формате `rwxrwxrwx`:  

- **Первая тройка** (`rwx`) — права владельца файла.  
- **Вторая тройка** (`rwx`) — права группы, которой принадлежит файл.  
- **Третья тройка** (`rwx`) — права для всех остальных пользователей.  

Разберем, что означает каждая буква:  

- `r` (read) = 1 — можно читать файл, `r` = 0 — чтение запрещено.  
- `w` (write) = 1 — можно изменять (перезаписывать) файл, `w` = 0 — нельзя.  
  ⚠️ **Но!** Перезаписывать файл может только его владелец, даже если у группы есть `w`.  
- `x` (execute) — в данном контексте не учитывается.  

#### Как дать всем доступ к просмотру файла (например, аватара)? 
Нужно установить права так, чтобы последний бит (`r`) был 1: `xxxxxx100` (на место `x` можно поставить любые значения).  

#### Права по умолчанию:  
Если явно не изменить, система задает стандартные права: `rwxr-xr--` (`111101100` в двоичном виде).

#### Пример работы с правами
**Кейс 1**: арендодатель высылает договор в чат арендатору, в данном случае арендодатель - владелец файла, у него есть все доступы => давать ничего ему больше не надо. Арендатор в свою очередь не имеет никаких доступов к файлу => нам нужно или добавить его в группу, или открыть файл для всех. второй вариант явно херовый поэтому добавим арендатора в группу и дадим группе возможность читать\
Итог: файл имеет права rwxr----- (11100000) и арендатор включен в группу

**Кейс 2**: хотим добавить аватарки. загружаемые файлы мы никак не хотим защищать, наооборот хочется чтобы все заценили новую аватарку на платформе => нужно открыть доступ на чтение для всех пользователей\
Итог: файл имеет права rwx---r-- (111000100) и все могут поглядеть на аватарку. в данном контексте нам группа вообще не требуется, можно ей даже права не выдавать.

## Как получать / загружать файлы

Используются presigned urls. Перед получением / загрузкой на платформу файла нужно попросить у бэка эту presigned url. Делаем POST запрос на `/someshit/upload` или `/someshit/get` и получаем presigned url если все ок.

#### Как загрузить файл
1. Отправляем `POST`-запрос на бэкенд (`/someshit/upload`).
2. Если все ок, получаем **presigned URL**.
3. Используя `PUT`-запрос с **multipart-загрузкой**, отправляем файл по полученной ссылке.

#### Как скачать файл
1. Отправляем `POST`-запрос на бэкенд (`/someshit/get`).
2. Если все ок, получаем **presigned URL**.
3. Делаем `GET`-запрос на этот URL.

## Что с безопасностью?
- **Presigned URLs** действуют **ограниченное время**, после чего становятся недоступны.  
- Бэкенд **проверяет права пользователя** перед выдачей `presigned URL`.  - Доступ к файлам контролируется через **права доступа (`rwxrwxrwx`)**, что позволяет ограничивать просмотр, изменение и скачивание.  
- Хранимые файлы могут быть **зашифрованы** средствами **S3 SSE (Server-Side Encryption)** или **KMS (Key Management Service)**.  
